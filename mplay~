#!/bin/bash
# wrapper around mpg321


DIR=$HOME/.mplay
PIPE=$DIR/pipe
PLAYER=mpg123
OPTS="-R"
MODE=""
FILE=""
VOLUME=$DIR/volume
PLAYHISTORY=$DIR/playhistory


assert_dir() {
  if [ ! -d $DIR ]
  then
    mkdir $DIR
  fi
}


assert_pipe() {
  if [ ! -p $PIPE ]
  then
    mkfifo $PIPE
  fi
}


assert_open() {
  tail -f > $PIPE &
}


assert_volume() {
  if [ ! -f $VOLUME ]
  then
    echo "50" > $VOLUME
  fi

  volume=`cat $VOLUME`

  re='^[0-9]+$'

  if ! [[ $volume =~ $re ]]
  then
    echo "50" > $VOLUME
  else
    if [ $volume -lt 0 ]
    then
      echo "0" > $VOLUME
    elif [ $volume -gt 100 ]
    then
      echo "100" > $VOLUME
    fi
  fi
}


set_vol() {
  echo "VOLUME `cat $VOLUME`" > $PIPE
}


assert_player() {
  ps_count=`ps -C $PLAYER | wc -l`

  if [ $ps_count -eq 1 ] 
  then
    assert_open

    $PLAYER $OPTS < $PIPE &> /dev/null &
  elif [ $ps_count -gt 2 ]
  then
    echo "Too many instances of $PLAYER"
    exit 1
  fi
}


assert_all() {
  assert_dir

  assert_pipe

  assert_player

  assert_volume
}


seek_back() {
  echo "jump -$1" > $PIPE
}


seek_forward() {
  echo "jump +$1" > $PIPE
}


vol_up() {
  old_volume=`cat $VOLUME`
  new_volume=$(($old_volume+10))

  if [ $new_volume -gt 100 ]
  then
    new_volume=100
  fi

  echo "$new_volume" > $VOLUME
}


vol_down() {
  old_volume=`cat $VOLUME`
  new_volume=$(($old_volume-10))

  if [ $new_volume -lt 0 ]
  then
    new_volume=0
  fi

  echo "$new_volume" > $VOLUME
}


is_file() {
  if [ ! -f $1 ]
  then
    >&2 echo "Error: file \"$1\" not found"
    exit 1
  fi
}


load_file_or_playlist() {
  ext=${1#*.}
  
  file=`readlink -f $1`
  echo $file >> $PLAYHISTORY

  if [ $ext = "m3u" ]
  then
    load_playlist $file
  else
    load_file $file
  fi
}


# only plays first song
# TODO
load_playlist() {
  is_file $1

  echo "LOADLIST 1 $1" > $PIPE
}


load_file() {
  is_file $1

  echo "LOAD $1" > $PIPE
}


toggle_pause() {
  echo "PAUSE" > $PIPE
}


repeat_last() {
  last=`tail -1 $PLAYHISTORY`

  if [ -f $last ]
  then
    load_file_or_playlist $last
  fi
}


show_help() {
  echo -e "\nUsage: ${0##*/} [FILE | < | > | [ | ] | - | + ]\n" \
          "  < : jump -1min\n" \
          "  > : jump +1min\n" \
          "  [ : jump -5min\n" \
          "  ] : jump +5min\n" \
          "  - : vol  -10% \n" \
          "  + : vol  +10% \n" \
          "  r : repeat last file \n" \
          "\nTip: make playlists with mp3wrap\n" \
          "   mp3wrap OUTPUTFILE file1 file2 ...\n"
}


# one frame is 0.026 seconds
# one second is 38 frames
# one minute is 2308 frames
# five minutes is 11538 frames
main() {
  if [ $# -gt 1 ]
  then
    >&2 echo "Error: too many arguments"
    show_help
    exit 1
  else
    assert_all

    if [ $# -eq 1 ]
    then
      case "${1}" in
        "<")
          seek_back 2308
          ;;
        ">")
          seek_forward 2308
          ;;
        "[")
          seek_back 11538
          ;;
        "]")
          seek_forward 11538
          ;;
        "-")
          vol_down
          ;;
        "+")
          vol_up
          ;;
        "r")
          repeat_last
          ;;
        "-h")
          show_help
          exit 0
          ;;
        *)
          load_file_or_playlist $1
          ;;
      esac
    else
      toggle_pause
    fi

    set_vol
  fi
}


main $@
